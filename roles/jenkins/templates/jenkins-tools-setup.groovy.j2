import hudson.tasks.Maven.MavenInstallation
import hudson.tools.ZipExtractionInstaller
import hudson.tools.InstallSourceProperty
import hudson.model.JDK
import hudson.plugins.sonar.SonarInstallation
import hudson.plugins.gradle.GradleInstallation
import jenkins.plugins.nodejs.tools.NodeJSInstallation
import hudson.plugins.sonar.SonarGlobalConfiguration

def instance = jenkins.model.Jenkins.instance

JAVA: {
  def installations = []

  {% for item in jenkins_tools_config %}
    {% if item.type == 'java' %}
      println("Adding {{ item.type }} instance {{ item.name }} from the url {{ item.home }}")
      installations.add(new JDK("{{ item.name}}", "{{ item.home }}", null));
    {% endif %}
  {% endfor %}

  def descriptor = new JDK.DescriptorImpl()
  descriptor.setInstallations(installations.toArray(new JDK[0]));
}

MAVEN: {
  def installations = []

  {% for item in jenkins_tools_config %}
    {% if item.type == 'maven' %}
      println("Adding {{ item.type }} instance {{ item.name }} from the url {{ item.url }}")
      def installer = new ZipExtractionInstaller("", "{{ item.url }}", "{{ item.subdirectory }}")
      installations.add(new MavenInstallation("{{ item.name }}", "", [new InstallSourceProperty([installer])]))
    {% endif %}
  {% endfor %}

  def descriptor = instance.getDescriptor(MavenInstallation)
  descriptor.setInstallations(installations.toArray(new MavenInstallation[0]))
}

SONAR: {
  // See: https://github.com/SonarSource/sonar-scanner-jenkins
  def installations = []

  {% for item in jenkins_tools_config %}
    {% if item.type == 'sonar' %}
      println("Adding {{ item.type }} instance {{ item.name }} to the url {{ item.url }}")
      installations.add(new SonarInstallation(
              "{{ item.name }}",          // name
              "{{ item.url }}",           // serverUrl
              "{{ item.version }}",       // serverVersion
              "",                         // serverAuthenticationToken
              "",                         // databaseUrl
              "",                         // databaseLogin
              "",                         // databasePassword
              "",                         // mojoVersion
              "",                         // additionalProperties
              null,                       // triggers
              "",                         // sonarLogin
              "",                         // sonarPassword
              ""))                        // additionalAnalysisProperties
    {% endif %}
  {% endfor %}

  def descriptor = instance.getDescriptor(SonarGlobalConfiguration)
  descriptor.setInstallations(installations.toArray(new SonarInstallation[0]))
}

GRADLE: {
  def installations = []

  {% for item in jenkins_tools_config %}
    {% if item.type == 'gradle' %}
      println("Adding {{ item.type }} instance {{ item.name }} from the url {{ item.url }}")
      def installer = new ZipExtractionInstaller("", "{{ item.url }}", "")
      def installerSourceProperty = new InstallSourceProperty([installer])
      installations.add(new GradleInstallation("{{ item.name }}", "", [installerSourceProperty]));
    {% endif %}
  {% endfor %}

  def descriptor = instance.getDescriptor(GradleInstallation)
  descriptor.setInstallations(installations.toArray(new GradleInstallation[0]))
}

NODEJS: {
  def installations = []

  {% for item in jenkins_tools_config %}
    {% if item.type == 'nodejs' %}
      println("Adding {{ item.type }} instance {{ item.name }} from the url {{ item.url }}")
      def installer = new ZipExtractionInstaller("", "{{ item.url }}", "{{ item.subdirectory }}")
      def installerSourceProperty = new InstallSourceProperty([installer])
      installations.add(new NodeJSInstallation("{{ item.name }}", "", [installerSourceProperty]));
    {% endif %}
  {% endfor %}

  def descriptor = instance.getDescriptor(NodeJSInstallation)
  descriptor.setInstallations(installations.toArray(new NodeJSInstallation[0]))
}
